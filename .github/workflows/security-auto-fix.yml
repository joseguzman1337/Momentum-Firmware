name: Security Auto-Fix with Local Runners
on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:
  issues:
    types: [labeled]

jobs:
  auto-fix-vulnerabilities:
    runs-on: self-hosted
    if: contains(github.event.issue.labels.*.name, 'auto-fix')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: |
          pip install anthropic openai requests

      - name: Determine AI Agent
        id: agent
        run: |
          if [[ "${{ contains(github.event.issue.labels.*.name, 'claude') }}" == "true" ]]; then
            echo "agent=claude" >> $GITHUB_OUTPUT
          else
            echo "agent=codex" >> $GITHUB_OUTPUT
          fi

      - name: Extract vulnerability details
        id: vuln
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          ALERT_NUM=$(echo "$ISSUE_BODY" | grep -oP 'Alert.*#\K\d+' || echo "unknown")
          FILE=$(echo "$ISSUE_BODY" | grep -oP 'File.*`\K[^`]+' || echo "unknown")
          LINE=$(echo "$ISSUE_BODY" | grep -oP 'Line.*\K\d+' || echo "0")
          RULE=$(echo "$ISSUE_BODY" | grep -oP 'Rule.*`\K[^`]+' || echo "unknown")

          echo "alert_num=$ALERT_NUM" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "line=$LINE" >> $GITHUB_OUTPUT
          echo "rule=$RULE" >> $GITHUB_OUTPUT

      - name: Run AI Fix Generator
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AGENT: ${{ steps.agent.outputs.agent }}
          VULN_FILE: ${{ steps.vuln.outputs.file }}
          VULN_LINE: ${{ steps.vuln.outputs.line }}
          VULN_RULE: ${{ steps.vuln.outputs.rule }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 .ai/security/scripts/ai_fix_generator.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: resolve ${{ steps.vuln.outputs.rule }} in ${{ steps.vuln.outputs.file }}"
          branch: "auto-fix/${{ steps.agent.outputs.agent }}-${{ steps.vuln.outputs.alert_num }}"
          title: "[${{ steps.agent.outputs.agent }}] Fix ${{ steps.vuln.outputs.rule }}"
          body: |
            ## Automated Security Fix

            **Generated by**: ${{ steps.agent.outputs.agent }} AI Agent
            **Issue**: #${{ github.event.issue.number }}
            **Alert**: #${{ steps.vuln.outputs.alert_num }}
            **Rule**: `${{ steps.vuln.outputs.rule }}`

            ### Changes
            - Fixed vulnerability in `${{ steps.vuln.outputs.file }}:${{ steps.vuln.outputs.line }}`

            ### Verification
            - [ ] Code compiles successfully
            - [ ] Security scan passes
            - [ ] No regressions introduced

            Closes #${{ github.event.issue.number }}
          labels: |
            security
            auto-fix
            ${{ steps.agent.outputs.agent }}
          assignees: ${{ github.actor }}
